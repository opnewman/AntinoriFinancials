<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nori - Ownership Tree Visualization</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --color-primary: #14532D;
            --color-secondary: #0F172A;
            --color-background: #FFFFFF;
            --color-text: #1E293B;
            --color-accent: #22C55E;
            --color-warning: #EF4444;
            --color-border: #E2E8F0;
            --color-node-bg: #F8FAFC;
            --color-node-hover: #F1F5F9;
            --color-link: #64748B;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }
        
        /* Navigation Bar */
        .navbar {
            background-color: var(--color-primary);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .navbar-brand {
            font-size: 1.4rem;
            font-weight: 600;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .navbar-subtitle {
            font-size: 0.9rem;
            margin-left: 12px;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .navbar-links {
            display: flex;
            gap: 20px;
        }
        
        .navbar-link {
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .navbar-link:hover {
            color: white;
        }
        
        .navbar-link.active {
            color: white;
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 2px;
        }
        
        /* Main layout */
        .container {
            max-width: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            height: calc(100vh - 48px); /* Adjust for navbar */
        }
        
        .sidebar {
            width: 300px;
            background-color: var(--color-node-bg);
            border-right: 1px solid var(--color-border);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar h1 {
            color: var(--color-primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .control-panel {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
        }
        
        .search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            margin-bottom: 12px;
            font-family: inherit;
        }
        
        .view-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .btn {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background-color: #0D3D21;
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }
        
        .btn-outline:hover {
            background-color: rgba(20, 83, 45, 0.1);
        }
        
        .client-list {
            list-style: none;
            margin-top: 10px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .client-item {
            padding: 10px;
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .client-item:hover {
            background-color: var(--color-node-hover);
        }
        
        .client-item.active {
            background-color: rgba(20, 83, 45, 0.1);
            font-weight: 500;
            border-left: 3px solid var(--color-primary);
        }
        
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .breadcrumb {
            font-size: 0.9rem;
            color: var(--color-link);
        }
        
        .breadcrumb span {
            margin: 0 5px;
        }
        
        .tree-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: var(--color-node-bg);
            border-radius: 4px;
            padding: 12px 16px;
            min-width: 160px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-link);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-secondary);
        }
        
        .tree-visualization {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-node-bg);
            position: relative;
        }
        
        /* D3 Tree styling */
        .node {
            cursor: pointer;
        }
        
        .node circle {
            fill: white;
            stroke: var(--color-primary);
            stroke-width: 2px;
        }
        
        .node text {
            font-size: 12px;
            font-family: 'Inter', sans-serif;
        }
        
        .node-internal circle {
            fill: var(--color-accent);
        }
        
        .link {
            fill: none;
            stroke: var(--color-link);
            stroke-width: 1px;
        }
        
        .node-card {
            fill: white;
            stroke: var(--color-border);
            rx: 4;
            ry: 4;
        }
        
        .node-card-selected {
            stroke: var(--color-primary);
            stroke-width: 2px;
        }
        
        .node-title {
            font-weight: 600;
            font-size: 12px;
        }
        
        .node-subtitle {
            font-size: 10px;
            fill: var(--color-link);
        }
        
        .node-value {
            font-size: 11px;
            font-weight: 500;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 300px;
            z-index: 1000;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
            
            .main-content {
                height: calc(100vh - 300px);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            nori <span class="navbar-subtitle">Financial Portfolio Reporting</span>
        </a>
        <div class="navbar-links">
            <a href="/" class="navbar-link">Dashboard</a>
            <a href="/upload.html" class="navbar-link">Upload</a>
            <a href="/ownership-tree" class="navbar-link active">Ownership Tree</a>
            <a href="/ownership-explorer" class="navbar-link">Relationship Explorer</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="sidebar">
            <h1><a href="/" style="text-decoration: none; color: var(--color-primary);">Ownership Tree</a></h1>
            
            <div class="control-panel">
                <div class="view-controls" style="margin-bottom: 15px;">
                    <a href="/" class="btn btn-outline" style="text-decoration: none;">
                        <i class="fas fa-arrow-left" style="margin-right: 5px;"></i> Back to Dashboard
                    </a>
                </div>
                <input type="text" class="search-box" id="clientSearch" placeholder="Search clients...">
                <div class="view-controls">
                    <button class="btn" id="expandAllBtn">Expand All</button>
                    <button class="btn btn-outline" id="collapseAllBtn">Collapse All</button>
                </div>
                <div class="view-controls">
                    <button class="btn btn-outline" id="refreshDataBtn">Refresh Data</button>
                </div>
            </div>
            
            <h2>Clients</h2>
            <ul class="client-list" id="clientList">
                <!-- Client list will be populated dynamically -->
                <li class="client-item">Loading clients...</li>
            </ul>
        </div>
        
        <div class="main-content">
            <div class="tree-header">
                <div class="breadcrumb">
                    <a href="/">Home</a> <span>›</span> <a href="/ownership-tree">Ownership Tree</a> <span>›</span> <strong id="currentClient">All Clients</strong>
                </div>
                <div class="view-controls">
                    <button class="btn btn-outline" id="downloadBtn">Export PNG</button>
                </div>
            </div>
            
            <div class="tree-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Value</div>
                    <div class="stat-value" id="totalValue">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Accounts</div>
                    <div class="stat-value" id="accountCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Entities</div>
                    <div class="stat-value" id="entityCount">0</div>
                </div>
            </div>
            
            <div class="tree-visualization" id="treeContainer">
                <div class="loading" id="loadingIndicator">
                    <p>Loading ownership data...</p>
                </div>
                <!-- D3 visualization will be rendered here -->
            </div>
        </div>
    </div>
    
    <script>
        // Main application code
        document.addEventListener('DOMContentLoaded', function() {
            // State management
            const state = {
                treeData: null,
                clients: [],
                selectedClient: null,
                expandedNodes: new Set(),
                searchTerm: '',
                loading: true
            };
            
            // DOM Elements
            const clientList = document.getElementById('clientList');
            const clientSearch = document.getElementById('clientSearch');
            const currentClient = document.getElementById('currentClient');
            const treeContainer = document.getElementById('treeContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const totalValue = document.getElementById('totalValue');
            const accountCount = document.getElementById('accountCount');
            const entityCount = document.getElementById('entityCount');
            const expandAllBtn = document.getElementById('expandAllBtn');
            const collapseAllBtn = document.getElementById('collapseAllBtn');
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            // Initialize tooltip div
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
            
            // Fetch ownership tree data
            async function fetchOwnershipTree(forceRefresh = false) {
                state.loading = true;
                updateLoadingState();
                
                try {
                    const url = forceRefresh ? '/api/ownership-tree?force_refresh=true' : '/api/ownership-tree';
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to load ownership data');
                    }
                    
                    state.treeData = data.data;
                    processTreeData();
                    renderTree();
                    
                    console.log(`Tree loaded in ${data.processing_time_seconds} seconds. From cache: ${data.from_cache || false}`);
                } catch (error) {
                    console.error('Error fetching ownership tree:', error);
                    showError(error.message);
                } finally {
                    state.loading = false;
                    updateLoadingState();
                }
            }
            
            // Process tree data to extract clients and prepare visualization
            function processTreeData() {
                if (!state.treeData || !state.treeData.children) {
                    state.clients = [];
                    return;
                }
                
                // Extract client nodes from tree data
                state.clients = state.treeData.children.map(client => ({
                    name: client.name,
                    data: client
                })).sort((a, b) => a.name.localeCompare(b.name));
                
                // Update client list UI
                renderClientList();
            }
            
            // Render client list
            function renderClientList() {
                clientList.innerHTML = '';
                
                if (state.clients.length === 0) {
                    const li = document.createElement('li');
                    li.className = 'client-item';
                    li.textContent = 'No clients found';
                    clientList.appendChild(li);
                    return;
                }
                
                // Filter clients by search term if needed
                const filteredClients = state.searchTerm ? 
                    state.clients.filter(client => 
                        client.name.toLowerCase().includes(state.searchTerm.toLowerCase())
                    ) : state.clients;
                
                filteredClients.forEach(client => {
                    const li = document.createElement('li');
                    li.className = 'client-item';
                    if (state.selectedClient === client.name) {
                        li.classList.add('active');
                    }
                    li.textContent = client.name;
                    li.addEventListener('click', () => {
                        selectClient(client.name);
                    });
                    clientList.appendChild(li);
                });
            }
            
            // Select a client and update tree view
            function selectClient(clientName) {
                state.selectedClient = clientName;
                currentClient.textContent = clientName || 'All Clients';
                renderClientList(); // Update active state in list
                renderTree(); // Update tree visualization
            }
            
            // Calculate node values and counts recursively
            function calculateNodeStats(node) {
                let totalValue = 0;
                let accounts = 0;
                let entities = 0;
                
                if (node.value) {
                    // This is a leaf node (account)
                    totalValue += node.value || 0;
                    accounts += 1;
                    if (node.entity_id) {
                        entities += 1;
                    }
                    return { totalValue, accounts, entities };
                }
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        const childStats = calculateNodeStats(child);
                        totalValue += childStats.totalValue;
                        accounts += childStats.accounts;
                        entities += childStats.entities;
                    });
                }
                
                // Store stats on the node for later use
                node._stats = { totalValue, accounts, entities };
                return { totalValue, accounts, entities };
            }
            
            // Format currency values
            function formatCurrency(value) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }
            
            // Update the stats display
            function updateStats(node) {
                if (!node) {
                    totalValue.textContent = '$0';
                    accountCount.textContent = '0';
                    entityCount.textContent = '0';
                    return;
                }
                
                const stats = node._stats || calculateNodeStats(node);
                totalValue.textContent = formatCurrency(stats.totalValue);
                accountCount.textContent = stats.accounts.toLocaleString();
                entityCount.textContent = stats.entities.toLocaleString();
            }
            
            // Render the tree visualization using D3
            function renderTree() {
                // Clear previous visualization
                d3.select("#treeContainer svg").remove();
                
                if (!state.treeData) {
                    return;
                }
                
                // Get container dimensions
                const containerWidth = treeContainer.clientWidth;
                const containerHeight = treeContainer.clientHeight;
                
                // Determine which data to use based on selected client
                let rootData;
                
                if (state.selectedClient) {
                    // Find the selected client node
                    const clientNode = state.treeData.children.find(client => 
                        client.name === state.selectedClient
                    );
                    
                    if (clientNode) {
                        rootData = clientNode;
                        // Update stats for this client
                        updateStats(clientNode);
                    } else {
                        rootData = state.treeData;
                        updateStats(state.treeData);
                    }
                } else {
                    // Use the full tree
                    rootData = state.treeData;
                    updateStats(state.treeData);
                }
                
                // Create tree layout
                const treeLayout = d3.tree()
                    .size([containerHeight - 80, containerWidth - 400])
                    .nodeSize([80, 200]);
                
                // Create hierarchy and compute layout
                const root = d3.hierarchy(rootData);
                
                // Apply initial collapse state based on expanded nodes set
                root.descendants().forEach(d => {
                    const nodePath = getNodePath(d);
                    d._children = d.children;
                    if (d.depth < 1 || state.expandedNodes.has(nodePath)) {
                        d.children = d._children;
                    } else {
                        d.children = null;
                    }
                });
                
                const tree = treeLayout(root);
                
                // Create SVG container
                const svg = d3.select("#treeContainer")
                    .append("svg")
                    .attr("width", containerWidth)
                    .attr("height", containerHeight)
                    .append("g")
                    .attr("transform", `translate(40, 40)`);
                
                // Add zoom behavior
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 3])
                    .on("zoom", (event) => {
                        svg.attr("transform", event.transform);
                    });
                
                d3.select("#treeContainer svg")
                    .call(zoom)
                    .on("dblclick.zoom", null); // Disable double-click zoom
                
                // Define links between nodes
                const link = svg.selectAll(".link")
                    .data(tree.links())
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x)
                    );
                
                // Create node groups
                const node = svg.selectAll(".node")
                    .data(root.descendants())
                    .enter()
                    .append("g")
                    .attr("class", d => `node ${d.children ? "node-internal" : "node-leaf"}`)
                    .attr("transform", d => `translate(${d.y},${d.x})`)
                    .on("click", (event, d) => {
                        // Toggle node expansion
                        toggleNode(d);
                        event.stopPropagation();
                    })
                    .on("mouseover", (event, d) => {
                        showNodeTooltip(event, d);
                    })
                    .on("mouseout", () => {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0);
                    });
                
                // Node backgrounds (cards)
                node.append("rect")
                    .attr("class", "node-card")
                    .attr("x", -60)
                    .attr("y", -25)
                    .attr("width", 120)
                    .attr("height", 50);
                
                // Node title text
                node.append("text")
                    .attr("class", "node-title")
                    .attr("dy", "-10")
                    .attr("text-anchor", "middle")
                    .text(d => {
                        // Truncate long names
                        const name = d.data.name || "Unknown";
                        return name.length > 15 ? name.substring(0, 12) + "..." : name;
                    });
                
                // Node type/subtitle
                node.append("text")
                    .attr("class", "node-subtitle")
                    .attr("dy", "5")
                    .attr("text-anchor", "middle")
                    .text(d => {
                        if (d.data.entity_id) return "Account";
                        if (d.depth === 0) return "Client";
                        if (d.depth === 1) return "Group";
                        if (d.depth === 2) return "Portfolio";
                        return "";
                    });
                
                // Node value (for accounts)
                node.append("text")
                    .attr("class", "node-value")
                    .attr("dy", "20")
                    .attr("text-anchor", "middle")
                    .text(d => {
                        if (d.data.value) {
                            return formatCurrency(d.data.value);
                        } else if (d.data._stats && d.data._stats.totalValue) {
                            return formatCurrency(d.data._stats.totalValue);
                        }
                        return "";
                    });
                
                // Add expand/collapse indicators
                node.filter(d => d._children)
                    .append("circle")
                    .attr("class", "node-toggle")
                    .attr("r", 8)
                    .attr("cx", -70)
                    .attr("cy", 0)
                    .attr("fill", d => d.children ? "#22C55E" : "white") 
                    .attr("stroke", "#14532D")
                    .attr("stroke-width", 1.5);
                
                node.filter(d => d._children)
                    .append("text")
                    .attr("class", "node-toggle-icon")
                    .attr("x", -70)
                    .attr("y", 4)
                    .attr("text-anchor", "middle")
                    .attr("font-size", "12px")
                    .attr("fill", "#14532D")
                    .text(d => d.children ? "-" : "+");
            }
            
            // Toggle node expansion/collapse
            function toggleNode(d) {
                const nodePath = getNodePath(d);
                
                if (d.children) {
                    // Collapse node
                    d._children = d.children;
                    d.children = null;
                    state.expandedNodes.delete(nodePath);
                } else {
                    // Expand node
                    d.children = d._children;
                    state.expandedNodes.add(nodePath);
                }
                
                renderTree();
            }
            
            // Get a unique path for a node
            function getNodePath(d) {
                let path = '';
                let current = d;
                
                while (current) {
                    path = `/${current.data.name}${path}`;
                    current = current.parent;
                }
                
                return path;
            }
            
            // Show tooltip with detailed node information
            function showNodeTooltip(event, d) {
                let content = `<strong>${d.data.name}</strong><br>`;
                
                // Add node-type specific details
                if (d.data.entity_id) {
                    content += `Account: ${d.data.account_number || 'N/A'}<br>`;
                    content += `Entity ID: ${d.data.entity_id}<br>`;
                    if (d.data.value) {
                        content += `Value: ${formatCurrency(d.data.value)}<br>`;
                    }
                } else if (d.data._stats) {
                    // For parent nodes, show stats
                    content += `Total Value: ${formatCurrency(d.data._stats.totalValue)}<br>`;
                    content += `Accounts: ${d.data._stats.accounts}<br>`;
                    content += `Entities: ${d.data._stats.entities}<br>`;
                }
                
                tooltip.html(content)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px")
                    .transition()
                    .duration(200)
                    .style("opacity", .9);
            }
            
            // Show error message in the tree container
            function showError(message) {
                loadingIndicator.innerHTML = `<p style="color: var(--color-warning);">Error: ${message}</p>`;
                loadingIndicator.style.display = 'block';
            }
            
            // Update loading state UI
            function updateLoadingState() {
                if (state.loading) {
                    loadingIndicator.style.display = 'block';
                    loadingIndicator.innerHTML = '<p>Loading ownership data...</p>';
                } else {
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // Export tree as PNG image
            function exportAsPNG() {
                const svg = document.querySelector('#treeContainer svg');
                if (!svg) return;
                
                try {
                    // Create a canvas element
                    const canvas = document.createElement('canvas');
                    const svgWidth = svg.width.baseVal.value;
                    const svgHeight = svg.height.baseVal.value;
                    
                    canvas.width = svgWidth;
                    canvas.height = svgHeight;
                    const ctx = canvas.getContext('2d');
                    
                    // Set white background
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Convert SVG to an image
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const img = new Image();
                    
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        
                        // Create a download link
                        const link = document.createElement('a');
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const filename = `nori-ownership-${state.selectedClient || 'all'}-${timestamp}.png`;
                        
                        link.download = filename;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    };
                    
                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
                } catch (error) {
                    console.error('Error exporting PNG:', error);
                    alert('Failed to export image. Please try again.');
                }
            }
            
            // Expand all nodes
            function expandAllNodes() {
                // When we re-render the tree, we'll expand all nodes based on this flag
                const maxExpansionLevel = 5; // How deep to expand
                
                // Use D3 hierarchy to walk the nodes
                const root = d3.hierarchy(
                    state.selectedClient ? 
                    state.treeData.children.find(c => c.name === state.selectedClient) : 
                    state.treeData
                );
                
                if (!root) return;
                
                // Process all nodes in the hierarchy
                root.descendants().forEach(d => {
                    if (d.depth < maxExpansionLevel) {
                        const nodePath = getNodePath(d);
                        state.expandedNodes.add(nodePath);
                    }
                });
                
                renderTree();
            }
            
            // Collapse all nodes
            function collapseAllNodes() {
                state.expandedNodes.clear();
                renderTree();
            }
            
            // Set up event listeners
            clientSearch.addEventListener('input', () => {
                state.searchTerm = clientSearch.value;
                renderClientList();
            });
            
            expandAllBtn.addEventListener('click', expandAllNodes);
            collapseAllBtn.addEventListener('click', collapseAllNodes);
            refreshDataBtn.addEventListener('click', () => fetchOwnershipTree(true));
            downloadBtn.addEventListener('click', exportAsPNG);
            
            // Handle window resize
            window.addEventListener('resize', () => {
                renderTree();
            });
            
            // Initial data fetch
            fetchOwnershipTree();
        });
    </script>
</body>
</html>